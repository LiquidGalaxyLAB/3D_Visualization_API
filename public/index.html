<!DOCTYPE html>
<html>
   <head>
      <title>Graphical Liquid Galaxy API</title>
   </head>
   
   <script src = "/socket.io/socket.io.js"></script>
   <script src="https://threejs.org/build/three.js"></script>
   <script>
      const angleToGo = 50;
      var socket = io();
      var id;
      var angleCamera;
      var rotateCamera;
      var stopIm;
      socket.on('idSet', function(data) {
         id = data.id;
         angleCamera = data.angle;
         console.log(id + " " + angleCamera)
         rotateCamera = true;
         stopIm = false;
      });

      socket.on('whatTime', function() {
        if(id==1){
           socket.emit('currentTime', {pos:getCubePosition()});
           stopIm = true
        }
      });

      socket.on('setCube', function(data) {
         // console.log("setting positions");
         if(id!=1){
            setCubePosition(data.pos);
            stopIm = true;
            socket.emit('confirmation', id);
         }
      });

      socket.on('moveKeySock', function(data) {
         stopIm = true;
         if (data == 38) {
            // up arrow
            // console.log("Moving up");
            moveCamera(0,0.5,0);
         }
         else if (data == 40) {
            // down arrow
            // console.log("Moving down");
            moveCamera(0,-0.5,0);
         }
         else if (data == 37) {
            // left arrow
            // console.log("Moving left");
            moveCamera(-0.5,0,0);
         }
         else if (data == 39) {
            // right arrow
            // console.log("Moving right");
            moveCamera(0.5,0,0);
         }
         socket.emit('confirmation', id);
      });

      

      socket.on('start', function(data) {
         // console.log("Start");
         stopIm = false;
      });


      socket.on('updateIDReorganiseSock', function(data) {
         // console.log("reorganise " + id)
         if(id==2){
            id = 1;
            angleCamera = 0;
         }
         else if(id==1){
            id = 3;
            if(data.startRight){
               angleCamera = angleToGo;
            }else{
               angleCamera = -angleToGo
            }
         }
         else if(id%2 == 0){
            id = id-2;
            var angleAbs = Math.abs(angleCamera); 
            var lookingAt = (angleCamera/angleAbs);
            angleAbs-=angleToGo;
            angleCamera = angleAbs*lookingAt;
         }else{
            if(data.noUser > id){
               id += 2;
               var angleAbs = Math.abs(angleCamera); 
               var lookingAt = (angleCamera/angleAbs);
               angleAbs+=angleToGo;
               angleCamera = angleAbs*lookingAt;
            }
         }
         rotateCamera = true;
         // console.log("reorganise " + id)
         socket.emit('updateIDReorganise', data.id);
      })

      socket.on('updateIDMoveSock', function(data) {
         // console.log("move " + id)
         if(data%2 == id%2 && id > data){
            id -=2;
            var angleAbs = Math.abs(angleCamera); 
            var lookingAt = (angleCamera/angleAbs);
            angleAbs-=angleToGo;
            angleCamera = angleAbs*lookingAt;
            rotateCamera = true;
         }
         // console.log("move " + id)
         socket.emit('updateIDMove', data);
      })

      socket.on('updateIDMirrorSock', function() {
         // console.log("mirror " + id)
         if(id > 1){
            if(id%2==1){
               id--;
            }else{
               id++;
            }
         }
         // console.log("mirror " + id)
         socket.emit('updateIDMirror');
      })

      document.onkeydown = function checkKey(e) {
         e = e.keyCode;
         // console.log("MOVING " + e);
         socket.emit('moveKeySend', e);
      }
   </script>
   
   <body>
      <div id = "error-container"></div>
      <script src="main.js"></script>
   </body>
</html>