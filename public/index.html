<!DOCTYPE html>
<html>
   <head>
      <title>Graphical Liquid Galaxy API</title>
      <style type="text/css">  
         body { margin:0; }  
     </style> 
   </head>
   
   <script src = "/socket.io/socket.io.js"></script>
   <script src="https://threejs.org/build/three.js"></script>
   <script>
      const angleToGo = 50;
      var socket = io();
      var id;
      var angleCamera;
      var positionCamera = [0,0,0];
      var angleCameraOr;
      var positionCameraOr = [0,0,0];
      var rotateCamera;
      var stopIm;
      var center_camera_id1 = [0,0,0];

      socket.on('idSet', function(data) {
         
         id = data.id;
         angleCamera = data.angle;
         angleCameraOr = data.angle;
         positionCamera[0] = data.x;
         positionCamera[2] = data.z;
         positionCameraOr[0] = data.x;
         positionCameraOr[2] = data.z;
         rotateVectorInit(angleCamera);
         setCamera(positionCamera[0], 0, positionCamera[2]);
         console.log(id + " " + angleCamera + " " + data.x);
         
         rotateCamera = true;
         stopIm = false;
         init();
      });

      socket.on('whatTime', function() {
        if(id==1){
         //   console.log("sending position ")
           socket.emit('currentTime', {pos:getCubePosition()});
           stopIm = true
        }
      });

      socket.on('start', function(data) {
         // console.log("Start ");
         // console.log(Date.now());

         stopIm = false;
      });

      socket.on('setCube', function(data) {
         // if(d!=1){
            // console.log("setting positions");
            setCubePosition(data.pos);
            stopIm = true;
            socket.emit('confirmation', id);
         // }
      });

      var angleTilted = 0;

      socket.on('moveKeySock', function(data) {
         // stopIm = true;
         if (data == 38) {
            // up arrow
            // console.log("Moving up");
            positionCamera[1] += 0.5
            moveCamera(0,0.5,0);
            center_camera_id1[1] +=0.5
         }else if (data == 40) {
            // down arrow
            // console.log("Moving down");
            positionCamera[1] -= 0.5
            moveCamera(0,-0.5,0);
            center_camera_id1[1] -=0.5
         }else if (data == 65) {
            // a key --> moving left
            positionCamera[0] -= 0.5
            moveCamera(-0.5,0,0);
            center_camera_id1[0] -=0.5
         }else if (data == 68) {
            // d key --> moving right
            positionCamera[0] += 0.5
            moveCamera(0.5,0,0);
            center_camera_id1[0] +=0.5
         }else if (data == 87) {
            // w key --> moving forward
            positionCamera[2] -= 0.5
            moveCamera(0,0,-0.5);
            center_camera_id1[2] -=0.5
         }else if (data == 83) {
            // s key --> moving backwards
            positionCamera[2] += 0.5
            moveCamera(0,0,0.5);
            center_camera_id1[2] +=0.5
         }else if(data == 82){
            // r key --> reset
            angleCamera = angleCameraOr;
            changeAngleCurrentToOriginalCamera(angleCamera, positionCamera, center_camera_id1);
            positionCamera[0] = positionCameraOr[0];
            positionCamera[1] = positionCameraOr[1];
            positionCamera[2] = positionCameraOr[2];
            
            setCamera(positionCamera[0], positionCamera[1], positionCamera[2]);
            
            center_camera_id1 = [0,0,0]
         }else if(data == 81){
            // q key -->rotate around Z axis
            // angleTilted += 3;

            // var rotX = Math.cos(degreesToRadians(angleTilted)) *  (0.1 *(angleCamera/angleToGo));
            // var rotY = Math.sin(degreesToRadians(angleTilted)) *  (0.1 *(angleCamera/angleToGo));
            // console.log(rotX + " " + rotY);

            // console.log(Math.round((positionCamera[0] - rotX) * 100) / 100 + " " + Math.round((positionCamera[1] - rotY) * 100) / 100);
            // moveCamera(positionCamera[0] - rotX, positionCamera[1] -rotY, 0);

            // positionCamera[0] = rotX;
            // positionCamera[1] = rotY;
            rotateCameraZ(3, positionCamera, center_camera_id1);
            // console.log("rotateZ pos " + positionCamera)

         }else if(data == 69){
            // e key -->rotate around Z axis
            // angleTilted -= 3;
            // var rotX = (Math.cos(degreesToRadians(angleTilted)) *  (0.1*(angleCamera/angleToGo)));
            // var rotY = Math.sin(degreesToRadians(angleTilted)) *  (6*(angleCamera/angleToGo));
            // // console.log(rotX + " " + rotY);
            // // console.log((positionCamera[0] - rotX) + " " + (positionCamera[1] -rotY));
            // moveCamera(positionCamera[0] - rotX, positionCamera[1] -rotY, 0);
            // positionCamera[0] = rotX;
            // positionCamera[1] = rotY;
            // rotateCameraZ(-3);
            rotateCameraZ(-3, positionCamera, center_camera_id1);
            // console.log("rotateZ neg " + positionCamera);
         }
         // socket.emit('confirmation', id);
      });

      socket.on('updateIDReorganiseSock', function(data) {
         // console.log("reorganise " + id)
         if(id==2){
            id = 1;
            angleCamera = 0;
         }
         else if(id==1){
            id = 3;
            if(data.startRight){
               angleCamera = angleToGo;
            }else{
               angleCamera = -angleToGo
            }
         }
         else if(id%2 == 0){
            id = id-2;
            var angleAbs = Math.abs(angleCamera); 
            var lookingAt = (angleCamera/angleAbs);
            angleAbs-=angleToGo;
            angleCamera = angleAbs*lookingAt;
         }else{
            if(data.noUser > id){
               id += 2;
               var angleAbs = Math.abs(angleCamera); 
               var lookingAt = (angleCamera/angleAbs);
               angleAbs+=angleToGo;
               angleCamera = angleAbs*lookingAt;
            }
         }
         rotateCamera = true;
         // console.log("reorganise " + id)
         socket.emit('updateIDReorganise', data.id);
      })

      socket.on('updateIDMoveSock', function(data) {
         // console.log("move " + id)
         if(data%2 == id%2 && id > data){
            id -=2;
            var angleAbs = Math.abs(angleCamera); 
            var lookingAt = (angleCamera/angleAbs);
            angleAbs-=angleToGo;
            angleCamera = angleAbs*lookingAt;
            rotateCamera = true;
         }
         // console.log("move " + id)
         socket.emit('updateIDMove', data);
      })

      socket.on('updateIDMirrorSock', function() {
         // console.log("mirror " + id)
         if(id > 1){
            if(id%2==1){
               id--;
            }else{
               id++;
            }
         }
         // console.log("mirror " + id)
         socket.emit('updateIDMirror');
      })

      document.onkeydown = function checkKey(e) {
         e = e.keyCode;
         // console.log("MOVING " + e);
         socket.emit('moveKeySend', e);
      }

      var mouseDown;
      var mouseXBef;
      var mouseYBef;
      var howMuchMoved;
      document.onmousedown = function checkMouse(e) {
        
         if(e.which != 3){
            // console.log("mouse " + e.clientX);
            mouseDown = true;
            mouseXBef = e.clientX;
            mouseYBef = e.clientY;
         }
         
      }
      document.onmouseup = function checkMouse() {
         // console.log("mouse up");
         mouseDown = false
      }
      
      document.onmousemove = function checkMouse(e) {
         if(mouseDown){
            var howMuch = 50;
            var a = 3;
            // console.log("mouse dragging " + e.clientX);
            if(Math.abs(e.clientX - mouseXBef) >=howMuch){
               // console.log("moving X");
               if(mouseXBef>e.clientX){
                  a = -a
               }
               socket.emit('rotateYServer', a);
               // rotateCameraY(a);
               mouseXBef = e.clientX;
            }
            if(Math.abs(e.clientY - mouseYBef) >=howMuch){
               // console.log("moving Y");
               if(mouseYBef>e.clientY){
                  a = -a
               }
               socket.emit('rotateXServer', a);
               // rotateCameraX(a);
               mouseYBef = e.clientY;
            }
         }
      }
      socket.on('rotateX', function(data) {
         // console.log("RotateX " + data);
         rotateCameraX(data, positionCamera, center_camera_id1);
         // console.log("rotateX " + positionCamera);
      });
      socket.on('rotateY', function(data) {
         // console.log("RotateY " + data);
         // var rotX = Math.cos(degreesToRadians(data)) *  (0.1*(angleCamera/angleToGo));
         // var rotZ = Math.sin(degreesToRadians(data)) *  (0.1*(angleCamera/angleToGo));
         // // console.log(rotX + " " + rotZ);
         // moveCamera(positionCamera[0] - rotX, 0, positionCamera[2] -rotZ);
         // positionCamera[0] = rotX;
         // positionCamera[2] = rotZ;
         // rotateCameraY(data);
         rotateCameraY(data, positionCamera, center_camera_id1);
         // console.log("rotateY " + positionCamera)
      });
   </script>
   
   <body>
      <div id = "error-container"></div>
      <script src="main.js"></script>
   </body>
</html>